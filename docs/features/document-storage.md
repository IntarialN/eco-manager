# Блок «Артефакты / Хранилище документов»

Секция для хранения всех экологических документов клиента: разрешения, отчёты, паспорта, договоры и др. Предоставляет загрузку, версионирование, аудит и контроль доступа.

## 1. Цели и KPI
- Обеспечить хранение всех артефактов с разграничением доступа.
- SLA загрузки документа ≤ 10 секунд, отклик на просмотр ≤ 2 секунды.
- 100% операций по загрузке/удалению фиксируются в журнале аудита.

## 2. Пользовательские сценарии

**Клиент**
- Загружает документы, выбирая тип и связанное требование.
- Просматривает список своих документов, скачивает файлы.
- Запрашивает аудит документа (опция «Загрузить с аудитом», платная услуга с отдельным счётом).

**Менеджер**
- Одобряет/отклоняет загруженные клиентом документы.
- Добавляет документы, подготовленные компанией.
- Помечает документ как подтверждающий выполнение требования.

**Специалист**
- Проводит аудит документов, оставляет комментарии и вердикт.
- Настраивает напоминания о предстоящем обновлении документов.

**Админ**
- Управляет типами документов и политиками хранения.
- Контролирует отчёты о версиях, резервном копировании.

## 3. Структура данных

- `Document`:
  - `id`, `client_id`, `site_id`, `requirement_id` (опционально), `contract_id` (опционально)
  - `type` (разрешение, отчёт, договор, акт, паспорт и т.д.)
  - `status` (`pending_review`, `approved`, `rejected`, `archived`)
  - `uploaded_by`, `uploaded_at`
  - `requires_audit` (bool), `audit_status`, `audit_comments`
  - `storage_url`, `file_hash`, `file_size`
- `DocumentVersion`:
  - `document_id`, `version_number`, `uploaded_at`, `uploaded_by`, `storage_url`
- `DocumentAccessLog`:
  - `document_id`, `user_id`, `action` (view/download/delete), `timestamp`

## 4. Функциональные требования

- Поддержка версионирования и отметки актуальной версии.
- Привязка к требованиям, договорам, календарным событиям.
- Теги и поиск (по типу, периоду, объекту, статусу).
- Возможность массовой загрузки (zip/drag-n-drop).
- Резервное копирование и политика хранения ≥ 30 дней.
- На карточке требования доступен быстрый импорт файла (админ/менеджер) и подтверждение/отклонение документа.
- Для каждого требования хранится история загрузок: серверная фильтрация по дате, статусу и комментарию + пагинация (10 записей на страницу) с отображением атрибутов и инициатора изменения.

## 5. UX и интерфейс

- На странице требования блок документов разбит на две карточки:
  - «Добавить документ» с мини-формой (название до 80 символов, тип, файл, radio «с аудитом/без аудита», подсказки о форматах).
  - «Связанные документы» со списком карточек.
- Карточки документов содержат:
  - бейдж типа, сокращённое название (truncate + title);
  - статусную окраску рамки;
  - иконку-подсказку в правом верхнем углу (при наведении — режим проверки, дата загрузки, аудитор);
  - кнопки «Открыть / Подтвердить / Отклонить».
- Для истории изменений предусмотрена форма фильтрации (date picker, статус, текст комментария) и пагинация — UX совпадает с ожидаемым паттерном для журналов в остальных блоках.
- На глобальном дэшборде остаются фильтры по типу/статусу/периоду и карточки с индикаторами выполнения.

## 6. Интеграции и события

- Связь с блоком требований (статус `approved` может переводить требование в `completed`).
- При выборе «с аудитом» создаётся задача для специалиста.
- По истечении срока действия документа генерируется событие в календаре.
- API для внешних загрузок (опционально) с токеном доступа.

## 7. Безопасность и соответствие

- Все файлы хранятся в защищённом storage, путь доступа подписывается одноразовыми ссылками.
- RLS: клиент видит только свои документы; менеджер/специалист — только назначенные.
- Логи аудита (кто скачал, кто удалил) доступны в админ-панели.
- TODO: после получения перечня НПА маппинг типов документов к нормативам.

## 8. Тестирование

- Проверка версионирования и восстановления предыдущих версий.
- Тесты прав доступа на чтение/изменение/удаление.
- Нагрузочные тесты на массовую загрузку (>= 100 файлов).
- Проверка целостности файлов (хеш-суммы).
- Unit-тест `tests/unit/RequirementDocumentActionsTest.php` покрывает сценарии upload/approve/reject на уровне `RequirementController`.

## Связанные документы и регламент обновлений

- `docs/requirements/catalog.md` — требования, для которых нужны подтверждающие документы.
- `docs/admin/reference-management.md` — справочник типов документов, политика хранения, журнал overrides.
- `docs/features/requirements-tracker.md` — логика статусов требований при загрузке/одобрении документов.
- `docs/features/calendar.md` — события обновления и напоминания по срокам действия документов.
- `docs/security/compliance.md` — требования к защите ПДн, шифрованию и журналированию.
- `docs/infra/runbook.md` — инструкции по хранению и бэкапам `uploads`.

Перед изменением функционала блока:
1. Проверить актуальность справочников в `reference-management.md` и правил требований.
2. Синхронизировать политику доступа с `roles-and-permissions.md`.
3. Обновить `docs/documentation-todo.md`/completed-лог и указать затронутые артефакты.

## Чек-лист готовности

- [x] Описаны сценарии для всех ролей.
- [x] Определена модель данных и статусная логика.
- [x] Зафиксированы интеграции с требованиями и календарём.
- [x] Учтены аспекты безопасности и резервного копирования.
- [ ] Добавлен маппинг типов документов к НПА (ожидает данных).
