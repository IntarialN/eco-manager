# Блок «Риски»

Блок оценивает вероятность и последствия нарушений экологического законодательства, помогает приоритизировать задачи и информирует о возможных штрафах.

## 1. Цели
- Автоматически вычислять риски на основании статусов требований, событий календаря и истории проверок.
- Показать клиенту потенциальные штрафы (статьи КоАП, диапазон сумм).
- Позволить команде фиксировать и закрывать риски с планом действий.
- При изменении статуса требования (`RequirementController::actionUpdateStatus`) риск автоматически обновляет свой статус (`open` → `mitigation` → `closed`).

## 2. Источники данных

- Статусы требований (`expired`, `blocked`).
- Просроченные события календаря (`overdue`).
- История нарушений и штрафов из анкеты/проверок.
- Изменения законодательства — вручную поддерживаемая лента (см. раздел 9), далее планируем автоматизацию.
- Ручные пометки менеджеров/специалистов.

## 3. Сценарии использования

**Клиент**
- Просматривает текущие риски по объектам.
- Видит потенциальный штраф и дату, к которой нужно устранить.
- Отмечает выполненные мероприятия, прикрепляет доказательства.

**Менеджер**
- Создаёт план действий, назначает ответственных, устанавливает дедлайны.
- Подтверждает закрытие риска после загрузки документов.

**Специалист**
- Выполняет действия по ликвидации риска, оставляет отчёт.
- Запрашивает др. подразделения (юридическое, бухгалтерия) при необходимости.

**Админ**
- Управляет справочником статей КоАП, привязкой к требованиям.
- Настраивает правила расчёта критичности (низкий/средний/высокий).

## 4. Модель данных

- `Risk`:
  - `id`, `client_id`, `site_id`
  - `source_type` (requirement/calendar/manual)
  - `source_id` (requirement_id/event_id)
  - `description`, `legal_reference` (статья КоАП), `fine_range` (min/max)
  - `severity` (low/medium/high), `probability` (0–100%), `score`
  - `status` (`open`, `mitigation`, `closed`, `escalated`)
  - `due_date`, `responsible_user_id`
- `RiskActionPlan`:
  - `risk_id`, `task`, `owner_id`, `due_date`, `status`
- `RiskLog`:
  - `risk_id`, `timestamp`, `user_id`, `action`, `notes`

## 5. Расчёт критичности

- Базовая оценка (`severity`) определяется по нормативу:
  - Требования с потенциальным штрафом > 500 тыс. руб → `high`
  - 100–500 тыс. руб → `medium`
  - < 100 тыс. руб → `low`
- `probability` зависит от:
  - времени просрочки (0–30/30–90/>90 дней),
  - количества предыдущих нарушений,
  - категории объекта по НВОС,
  - предполагаемой частоты проверок (см. раздел 6).
- `score = severity_weight * probability`, используется для сортировки.

## 6. Интеграции

- Получает события из блока требований/календаря.
- Публикует статусы в ленту изменений и уведомления.
- Ссылается на документы из хранилища (подтверждение устранения).

## 7. UX

- Дэшборд с плитками рисков (по критичности).
- Диаграмма изменения рискового балла во времени.
- Детальная карточка риска: источник, штраф, план действий, история.
- Фильтры по объектам, статусам, категориям НВОС.

## 8. Тестирование

- Проверка корректности расчёта при изменении статуса требования.
- Тесты на автоматическое закрытие риска после выполнения плана.
- Проверка прав доступа (клиент видит только свои риски).
- Нагрузочный тест на истории событий (>= 1000 записей).

## 9. Штрафы и частота проверок (рабочие допущения)

- Таблица штрафов ведётся в `docs/admin/reference-management.md` (раздел 1.4). При расчёте `severity` сервис подтягивает диапазон `fine_min/fine_max`.
- Рабочая частота проверок:
  - Объекты I категории — ежегодные проверки Росприроднадзора + внеплановые при нарушениях.
  - Объекты II категории — плановая проверка раз в 3 года.
  - Объекты III категории — плановая проверка раз в 5 лет.
  - Объекты IV категории — на основании заявлений/жалоб (редко), вероятность по умолчанию 10%.
- Эти значения используются для расчёта `probability` и уточняются при наличии отраслевых данных.

## 10. Лента изменений законодательства

- В админ-панели создаётся раздел «НПА-лента»: администратор добавляет запись (`date`, `act`, `summary`, `impact`).
- При добавлении записи система:
  1. Отправляет уведомление менеджерам клиентов, которых затрагивает изменение.
  2. Запускает пересчёт правил требований, если указано, что акт влияет на расчёт.
  3. Создаёт задачу в risk-service со статусом `mitigation`, если изменение требует действий клиента.
- До интеграции с внешними базами записи добавляются вручную (раз в неделю/месяц, по мере поступления информации).
- В дальнейшем можно автоматизировать загрузку через API консалтинговых систем.

## Связанные документы и порядок обновления

- `docs/requirements/catalog.md` и `docs/requirements/rules.md` — статус требований, которые инициируют риски.
- `docs/features/calendar.md` — просроченные события, влияющие на вероятность.
- `docs/admin/reference-management.md` — справочники штрафов, статьи КоАП, overrides.
- `docs/features/document-storage.md` — подтверждающие документы в планах действий.
- `docs/architecture/integration-plan.md` — события и уведомления, связанные с рисками.
- `docs/security/compliance.md` — требования по журналированию и уведомлениям при инцидентах.

Перед изменением модели рисков:
1. Свериться с актуальными штрафами и справочниками в `reference-management.md`.
2. Обновить связанные сценарии в требованиях/календаре и синхронизировать TODO.
3. Зафиксировать результат в `docs/completed/` и при необходимости добавить новые предположения в таблицу `docs/documentation-todo.md`.

## Чек-лист готовности

- [x] Описаны источники рисков и сценарии.
- [x] Определена модель данных и методика расчёта.
- [x] Учтены интеграции с другими блоками.
- [x] Заданы требования к UX и тестированию.
- [x] Зафиксированы рабочие допущения по штрафам, проверкам и ленте изменений (подлежат верификации).
