# Блок «Риски»

Блок оценивает вероятность и последствия нарушений экологического законодательства, помогает приоритизировать задачи и информирует о возможных штрафах.

## 1. Цели
- Автоматически вычислять риски на основании статусов требований, событий календаря и истории проверок.
- Показать клиенту потенциальные штрафы (статьи КоАП, диапазон сумм).
- Позволить команде фиксировать и закрывать риски с планом действий.

## 2. Источники данных

- Статусы требований (`expired`, `blocked`).
- Просроченные события календаря (`overdue`).
- История нарушений и штрафов из анкеты/проверок.
- Изменения законодательства (TODO: синхронизировать после описания ленты изменений).
- Ручные пометки менеджеров/специалистов.

## 3. Сценарии использования

**Клиент**
- Просматривает текущие риски по объектам.
- Видит потенциальный штраф и дату, к которой нужно устранить.
- Отмечает выполненные мероприятия, прикрепляет доказательства.

**Менеджер**
- Создаёт план действий, назначает ответственных, устанавливает дедлайны.
- Подтверждает закрытие риска после загрузки документов.

**Специалист**
- Выполняет действия по ликвидации риска, оставляет отчёт.
- Запрашивает др. подразделения (юридическое, бухгалтерия) при необходимости.

**Админ**
- Управляет справочником статей КоАП, привязкой к требованиям.
- Настраивает правила расчёта критичности (низкий/средний/высокий).

## 4. Модель данных

- `Risk`:
  - `id`, `client_id`, `site_id`
  - `source_type` (requirement/calendar/manual)
  - `source_id` (requirement_id/event_id)
  - `description`, `legal_reference` (статья КоАП), `fine_range` (min/max)
  - `severity` (low/medium/high), `probability` (0–100%), `score`
  - `status` (`open`, `mitigation`, `closed`, `escalated`)
  - `due_date`, `responsible_user_id`
- `RiskActionPlan`:
  - `risk_id`, `task`, `owner_id`, `due_date`, `status`
- `RiskLog`:
  - `risk_id`, `timestamp`, `user_id`, `action`, `notes`

## 5. Расчёт критичности

- Базовая оценка (`severity`) определяется по нормативу:
  - Требования с штрафами > 500 тыс. руб → `high`
  - 100–500 тыс. руб → `medium`
  - < 100 тыс. руб → `low`
- `probability` зависит от:
  - времени просрочки (0–30/30–90/>90 дней),
  - количества предыдущих нарушений,
  - категории объекта по НВОС.
- `score = severity_weight * probability`, используется для сортировки.
- TODO: уточнить актуальные размеры штрафов и частоту проверок по отраслям.

## 6. Интеграции

- Получает события из блока требований/календаря.
- Публикует статусы в ленту изменений и уведомления.
- Ссылается на документы из хранилища (подтверждение устранения).

## 7. UX

- Дэшборд с плитками рисков (по критичности).
- Диаграмма изменения рискового балла во времени.
- Детальная карточка риска: источник, штраф, план действий, история.
- Фильтры по объектам, статусам, категориям НВОС.

## 8. Тестирование

- Проверка корректности расчёта при изменении статуса требования.
- Тесты на автоматическое закрытие риска после выполнения плана.
- Проверка прав доступа (клиент видит только свои риски).
- Нагрузочный тест на истории событий (>= 1000 записей).

## Чек-лист готовности

- [x] Описаны источники рисков и сценарии.
- [x] Определена модель данных и методика расчёта.
- [x] Учтены интеграции с другими блоками.
- [x] Заданы требования к UX и тестированию.
- [ ] Уточнены параметры штрафов и частоты проверок (ожидает данных).
