# Блок «Карта требований»

Блок отображает все регуляторные обязательства клиента и статусы их исполнения. Основывается на расчётах из `docs/requirements/`.

## 1. Цели и KPI
- Обеспечить актуальный список требований с фильтрами по объектам, категориям, статусам.
- Минимизировать просрочки: SLA на обработку новых требований ≤ 2 рабочих дней.
- Поддерживать прозрачность — все изменения фиксируются в ленте аудита.

## 2. Пользовательские сценарии

**Клиент**
- Просматривает перечень требований и их статусы.
- Фильтрует список по объектам, типам (воздух, вода, отходы).
- Загружает доказательные документы, подтверждает выполнение.

**Менеджер**
- Устанавливает ответственных, сроки, статусы («В работе», «Выполнено»).
- Добавляет вручную требования (например, по указанию заказчика).
- Оставляет комментарии и задаёт напоминания.

**Специалист**
- Получает назначенные задачи по требованиям, обновляет прогресс.
- Запрашивает недостающие документы у клиента.

**Админ**
- Конфигурирует правила (вручную добавляет/исключает требования).
- Просматривает историю изменений, откатывает неверные операции.

## 3. Структура данных

- `Requirement`:
  - `id`, `client_id`, `site_id`
  - `code` (req_01 и т.д.), `title`, `category`, `group` (воздух/вода/отходы/прочее)
  - `status` (`new`, `in_progress`, `completed`, `blocked`, `expired`)
  - `due_date`, `renewal_period` (ежегодно/квартально/одноразово)
  - `responsible_user_id`
- `source_rule` (auto/manual/manual_override)
- `needs_clarification` (bool, например для req_11)
- `RequirementHistory`:
  - `requirement_id`, `timestamp`, `user_id`, `change_type`, `payload`
- `RequirementComment`:
  - `requirement_id`, `user_id`, `message`, `attachments`

## 4. Интерфейс и UX

- Таблица с группировкой по объектам; индикаторы статуса (цвет, иконка).
- Боковая панель фильтров (категория НВОС, блок регуляции, статус, ответственный).
- Карточка требования: общая информация, связанные документы, история, чек-лист действий.
- Уведомления о новых/просроченных требованиях (в том числе e-mail/чат-бот).
- Отдельный фильтр по статусам/просроченности и прогресс-бар выполнения на вкладке клиента.

## 5. Логика и автоматизация

- После расчёта требований новый элемент появляется в статусе `new`.
- При загрузке подтверждающего документа менеджер переводит статус в `in_progress`/`completed`.
- Если `due_date` истекла → статус `expired`, генерируется уведомление и отметка в «Риски».
- Менеджер и администратор могут менять статус из вкладки требования (дропдаун + кнопка «Обновить»), при `completed` автоматически фиксируется `completed_at`.
- Каждое изменение статуса фиксируется в истории (`requirement_history`), доступной на вкладке (collapse). Можно указать короткий комментарий (причину смены, ссылку на документ).
- Доступен отдельный экран требования (`/requirement/view/<id>`): карточка статуса, история, связанные документы, управление статусом.
- Автоообновление: однотипные требования автоматически создаются на следующий период после закрытия.
- Для требований с неоднозначными условиями (например, `req_11`) применяем принятые предположения: наличие отходов + ответственное лицо. При необходимости админ использует ручной флаг.

## 6. Интеграции и зависимости

- Требует данных из анкеты (`profile-logic`), правил (`requirements/rules.md`).
- Связан с календарём (генерация событий) и хранилищем (привязка документов).
- Изменения статусов должны отражаться в ленте событий и риск-оценке.

## 7. Проверки и тестирование

- Проверить корректность фильтров (комбинации категорий/статусов).
- Тесты на автоматическое создание требований по условиям (emission, waste, etc.).
- Проверка RLS: клиент видит только свои требования, менеджер — клиентов своего пула.
- Нагрузочные тесты при количестве требований > 1000 на клиента.
- Unit-тест `tests/unit/RequirementStatusUpdateTest.php` проверяет историю, синхронизацию рисков и событий календаря при смене статуса.

## Связанные документы и контроль изменений

- `docs/requirements/catalog.md` — перечень требований и нормативная база.
- `docs/requirements/rules.md` — алгоритмы автоназначения и входные атрибуты анкеты.
- `docs/admin/reference-management.md` — справочник НПА, ручные overrides, таблицы штрафов.
- `docs/features/document-storage.md` — связка требований и подтверждающих документов.
- `docs/features/risk-management.md` — оценка рисков при просроченных требованиях.
- `docs/features/calendar.md` — генерация событий и напоминаний по требованиям.

Перед изменением логики требований:
1. Свериться с актуальными справочниками и completed-записями (особенно по req_11).
2. Обновить связанные документы и синхронизировать статусы в `docs/documentation-todo.md`.
3. Зафиксировать результат отдельной записью в `docs/completed/` с перечнем обновлённых файлов.

## Чек-лист готовности

- [x] Определены сценарии по ролям.
- [x] Описана модель данных и статусная логика.
- [x] Отмечены интеграции с другими блоками.
- [x] Заданы критерии тестирования.
- [x] Учтено рабочее предположение по правилу req_11 (при необходимости уточнить нормативную базу).
