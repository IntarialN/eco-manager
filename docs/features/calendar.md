# Блок «Календарь событий»

Календарь агрегирует все сроки и мероприятия: отчётность, обновление документов, обучение, платежи и др. Является центральным инструментом планирования.

## 1. Цели
- Обеспечить единый источник актуальных дат для клиента и команды.
- Предупреждать о дедлайнах минимум за 14 дней до наступления.
- Автоматически продлевать события после закрытия требований.

## 2. Типы событий

- Отчётность (2-ТП, ПЭК, ДВОС, НДВ, НООЛР и т.д.)
- Обновление лицензий и разрешений (скважины, водопользование, КЭР).
- Проверки и аудиты (госнадзор, внутренний контроль).
- Платежи (плата за НВОС, услуги компании).
- Обучение (истечение удостоверений, плановые курсы).
- TODO: при интеграции с учётной системой уточнить события по договорам/счетам.

## 3. Сценарии использования

**Клиент**
- Просматривает календарь, получает уведомления о приближающихся датах.
- Отмечает события как выполненные, прикрепляет документы-отчёты.
- Создаёт собственные напоминания (например, внутренние собрания).

**Менеджер**
- Назначает ответственных за события, корректирует сроки.
- Связывает события с требованиями и документами.
- Отслеживает статистику просрочек.

**Специалист**
- Получает задачи на подготовку отчетов/документов.
- При выполнении обновляет статус события и связанную запись в требовании.

**Админ**
- Управляет шаблонами событий и периодичностью.
- Настраивает правила уведомлений (каналы, сроки).

## 4. Структура данных

- `CalendarEvent`:
  - `id`, `client_id`, `site_id`, `requirement_id` (опционально)
  - `title`, `description`, `event_type`, `periodicity` (одноразово/ежегодно/ежеквартально/кастом)
  - `start_date`, `due_date`, `reminder_offsets` (список дней)
  - `status` (`scheduled`, `in_progress`, `done`, `overdue`, `cancelled`)
  - `assigned_user_id`
- `EventReminder`:
  - `event_id`, `offset_days`, `channel` (email, push, чат-бот), `sent_at`
- `EventLog`:
  - `event_id`, `timestamp`, `action`, `user_id`, `notes`

## 5. Автоматизация

- При создании требования генерируются связанные события с учётом периодичности.
- После закрытия события автоматически планируется следующее (если периодичность > одноразового).
- Если событие связано с документом, проверяется актуальность документа (например, срок действия лицензии).
- Просроченные события переводятся в статус `overdue`, информация передаётся в блок «Риски».
- При смене статуса требования (`RequirementController::actionUpdateStatus`) связанные события переводятся в `done`, `scheduled` или `overdue` в зависимости от даты.

## 6. UX

- Представления: календарь (месяц/неделя), список, канбан по статусам.
- Цветовые метки по типу события и критичности.
- Возможность массового переноса событий (например, форс-мажор).
- Экспорт/синхронизация с внешними календарями (iCal, Outlook) — опционально.

## 7. Уведомления

- Система рассылает напоминания согласно `reminder_offsets`.
- Дополнительные уведомления при переходе статуса в `overdue`.
- Настраиваемые каналы (email, мессенджер, чат-бот, SMS — если потребуется).

## 8. Тестирование

- Проверка генерации событий для каждого типа требования.
- Тесты на повторяемость событий и корректную установку следующих дат.
- Проверка уведомлений и прав доступа (клиент не видит чужие события).
- Тесты на массовые операции (перенос, отмена).
- Unit-тест `tests/unit/RequirementStatusUpdateTest.php` подтверждает обновление статуса связанных событий при смене требования.

## Связанные документы и регламент обновлений

- `docs/features/requirements-tracker.md` — источники событий из требований и статусы при выполнении.
- `docs/features/document-storage.md` — проверки актуальности документов, привязанных к событиям.
- `docs/features/contracts-billing.md` — финансовые события и напоминания по договорам/счетам.
- `docs/admin/reference-management.md` — шаблоны событий и справочники периодичности.
- `docs/architecture/integration-plan.md` и `docs/architecture/mock-bubble-api.md` — интеграции, cron-синхронизация, SLA уведомлений.
- `docs/security/compliance.md` — требования к журналированию и уведомлениям.

Перед обновлением календарной логики:
1. Свериться с шаблонами в `reference-management.md` и актуальными интеграциями.
2. Обновить цепочку уведомлений и каналы в `integration-plan.md`, при необходимости — в notification-service.
3. Зафиксировать изменения в `docs/documentation-todo.md` и создать запись в `docs/completed/` со списком затронутых артефактов.

## Чек-лист готовности

- [x] Описаны типы событий и сценарии по ролям.
- [x] Определена модель данных и автоматизация.
- [x] Указаны интеграции с требованиями и рисками.
- [x] Описаны уведомления и тестирование.
- [ ] Уточнены события по договорам/счетам (ожидает данных от интеграции).
