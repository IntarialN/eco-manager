# Блок «Договоры / Счета / Акты»

Блок управляет финансовыми документами взаимодействия с клиентом: договоры, счета, акты, статусы оплат и связь с оказанными услугами.

## 1. Цели
- Предоставить клиенту прозрачность по финансовым документам и статусам.
- Автоматизировать синхронизацию с учётной системой (Бабл) и напоминания об оплатах.
- Отслеживать соответствие услуг выполненным требованиям.

## 2. Сценарии использования

**Клиент**
- Просматривает список договоров, счетов и актов.
- Загружает подписанные версии, отслеживает статусы оплат.
- Запрашивает счёт/акт, если ещё не сформирован.

**Менеджер**
- Создаёт карточку нового договора, привязывает к клиенту и объектам.
- Отправляет счета, отмечает поступление оплаты (если данные пришли вручную).
- Связывает договор с оказанными услугами/требованиями.

**Бухгалтер/Специалист**
- Проверяет корректность сумм, сроков, налоговых реквизитов.
- Формирует акты по завершённым работам, загружает сканы.

**Админ**
- Управляет справочником типов договоров, шаблонами документов.
- Настраивает интеграции и права доступа.

## 3. Структура данных

- `Contract`:
  - `id`, `client_id`, `title`, `number`, `date_signed`, `valid_until`
  - `status` (`draft`, `active`, `suspended`, `terminated`)
  - `total_amount`, `currency`, `related_requirements` (список id)
  - `integration_id` (ссылка на систему Бабл)
- `Invoice`:
  - `id`, `contract_id`, `number`, `issue_date`, `due_date`
  - `amount`, `currency`, `status` (`issued`, `paid`, `overdue`, `cancelled`)
  - `integration_id`, `payment_date`
- `Act`:
  - `id`, `contract_id`, `number`, `issue_date`, `status` (`draft`, `signed`, `pending_sign`, `archived`)
  - `linked_invoice_id`, `storage_doc_id`
- `BillingLog`:
  - `entity_type` (contract/invoice/act), `entity_id`, `timestamp`, `user_id`, `action`, `payload`

## 4. Интеграция с Бабл

- Периодическая синхронизация статусов договоров/счетов (pull).
- Вебхуки на события оплаты/формирования акта (push), если доступны.
- TODO: получить спецификацию API (аутентификация, поля, лимиты) и описать в `profile-logic`.

## 5. Автоматизация

- При переходе статуса счёта в `overdue` создаётся напоминание в календаре и риск «финансовая просрочка».
- Завершение работы по требованию → появляется задача сформировать акт.
- Изменения в статусах фиксируются в ленте событий клиента.
- Контроль сроков действия договора: за 30/7/1 день до истечения отправляются уведомления.

## 6. UX

- Табличное представление с вкладками «Договоры», «Счета», «Акты».
- Фильтры по статусам, датам, суммам.
- Карточка договора: условия, связанные объекты, список документов, история.
- Визуальные индикаторы просроченных счетов и истекающих договоров.

## 7. Тестирование

- Проверка корректности синхронизации данных (двухсторонняя).
- Тесты на расчёт статусов просрочки и уведомлений.
- Проверка прав доступа (клиент видит только свои документы, менеджер — по назначению).
- Тесты на целостность связи договор ↔ счета ↔ акты ↔ требования.

## Связанные документы и регламент обновлений

- `docs/architecture/mock-bubble-api.md` — контракт mock-сервиса и сценарии синхронизации.
- `docs/architecture/integration-plan.md` — каналы интеграций, cron-задачи, уведомления.
- `docs/features/calendar.md` — напоминания и события по договорам/счетам.
- `docs/features/requirements-tracker.md` и `docs/features/document-storage.md` — связь финансовых документов с выполнением требований и артефактами.
- `docs/admin/reference-management.md` — справочники типов документов и журнал overrides.
- `docs/security/compliance.md` — требования по защите финансовых данных и аудиту.

Порядок действий при изменении блока:
1. Свериться с актуальной спецификацией (mock или реальное API Bubble) и обновить интеграционные документы.
2. Проверить влияние на календарь, уведомления и RLS (матрицу ролей).
3. Отразить изменения в `docs/documentation-todo.md` и добавить запись в `docs/completed/` с перечнем обновлённых артефактов.

## Чек-лист готовности

- [x] Описаны сценарии по ролям.
- [x] Определена модель данных и автоматизация.
- [x] Учтены интеграции с календарём, требованиями, рисками.
- [ ] Получена и задокументирована спецификация API Бабл.
