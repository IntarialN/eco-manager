# Управление справочниками и ручными корректировками

Документ описывает, как админ-панель обеспечивает поддержку нормативных данных, правил построения требований и ручных правок.

## 1. Справочники

### 1.1 Нормативно-правовые акты (НПА)
- Поля: `code`, `title`, `link`, `effective_from`, `effective_to`, `category` (воздух/вода/отходы/прочее), `status` (draft/active/archive).
- Для каждого НПА храним список связанных требований и документов.
- Черновой перечень:
  | Код | Название | Категория | Ссылка |
  |-----|----------|-----------|--------|
  | ФЗ-7 | Федеральный закон «Об охране окружающей среды» | общая | http://www.consultant.ru/document/cons_doc_LAW_34823/ |
  | ФЗ-96 | Федеральный закон «Об охране атмосферного воздуха» | воздух | http://www.consultant.ru/document/cons_doc_LAW_12144/ |
  | ФЗ-89 | Федеральный закон «Об отходах производства и потребления» | отходы | http://www.consultant.ru/document/cons_doc_LAW_19109/ |
  | Пост. Правительства №913 | О нормативах образования отходов и лимитах на их размещение | отходы | http://www.consultant.ru/document/cons_doc_LAW_172196/ |
  | Приказ Минприроды №102 от 11.02.2021 | О форме и порядке ведения журналов учета движения отходов | отходы | http://www.consultant.ru/document/cons_doc_LAW_377677/ |
  | Приказ Росприроднадзора №349 от 08.08.2018 | Об утверждении форм статистической отчетности 2-ТП | воздух/отходы | http://www.consultant.ru/document/cons_doc_LAW_304255/ |
  | Приказ Минприроды №74 от 01.03.2021 | О порядке декларирования платы за НВОС | общая | http://www.consultant.ru/document/cons_doc_LAW_377669/ |
  | Пост. Правительства №262 от 03.03.2017 | О производственном экологическом контроле | общая | http://www.consultant.ru/document/cons_doc_LAW_214972/ |
  | СанПиН 2.2.1/2.1.1.1200-03 | Санитарно-защитные зоны | СЗЗ | http://www.consultant.ru/document/cons_doc_LAW_43396/ |
  | ФЗ-190 | Водный кодекс РФ | водопользование | http://www.consultant.ru/document/cons_doc_LAW_44983/ |
  | ФЗ-2395-1 | Закон «О недрах» | водопользование/скважины | http://www.consultant.ru/document/cons_doc_LAW_343/ |
  | Пост. Правительства №644 | Правила водопользования | водопользование | http://www.consultant.ru/document/cons_doc_LAW_149872/ |
  | Приказ Минсельхоза №551 от 06.12.2018 | Технические условия органических удобрений | побочные продукты | http://www.consultant.ru/document/cons_doc_LAW_315379/ |
  | КоАП РФ, гл. 8 | Административные правонарушения в области охраны окружающей среды | риски | http://www.consultant.ru/document/cons_doc_LAW_34661/ |

### 1.2 Правила построения требований
- Таблица `RequirementRule`:
  - `code` (req_01 …), `description`, `condition` (JSON/DSL), `source_npa`, `status`.
- Поддержка версионирования: изменения правил сохраняются с датой и автором.
- Возможна активация новой версии с отложенным вступлением в силу.

### 1.3 Типы документов
- Поля: `type_code`, `name`, `related_requirements`, `storage_policy` (срок хранения, размер).
- Связь с НПА для обоснования обязательности.
- Черновой маппинг:
  | Тип | Описание | Требования | НПА |
  |-----|----------|------------|-----|
  | `req_journal_waste` | Журнал учёта движения отходов | req_01 | Приказ Минприроды №102 |
  | `req_journal_sources` | Журнал учета стационарных источников | req_02 | ФЗ-96, Пост. №262 |
  | `stat_2tp_air` | Форма 2-ТП (воздух) | req_03 | Приказ Росприроднадзора №349 |
  | `stat_2tp_waste` | Форма 2-ТП (отходы) | req_04 | Приказ Росприроднадзора №349 |
  | `fee_declaration` | Декларация платы за НВОС | req_05 | Приказ Минприроды №74 |
  | `pek_report` | Отчёт ПЭК | req_06 | Пост. Правительства №262 |
  | `inventory_emissions` | Отчёт инвентаризации выбросов | req_08 | ФЗ-96 |
  | `inventory_waste` | Отчёт инвентаризации отходов | req_09 | ФЗ-89 |
  | `waste_passport` | Паспорт отходов | req_10 | ФЗ-89 |
  | `instructions_waste` | Инструкции и приказы | req_11 | ФЗ-89, Пост. №262 |
  | `noo_lr` | НООЛР | req_12 | Пост. Правительства №913 |
  | `ndv_project` | Нормативы допустимых выбросов | req_13/req_14 | ФЗ-96 |
  | `expert_conclusion` | Экспертное заключение НДВ | req_15 | ФЗ-96 |
  | `sanepid_conclusion` | СЭЗ на проект НДВ | req_16 | ФЗ-52 |
  | `nmu_plan` | План НМУ | req_17 | ФЗ-96 |
  | `ppek_program` | Программа ПЭК | req_18 | Пост. №262 |
  | `dvos` | Декларация воздействия | req_19 | ФЗ-7 |
  | `ker` | Комплексное разрешение | req_20 | ФЗ-7 |
  | `szz_project` | Проект СЗЗ | req_21 | СанПиН 2.2.1/2.1.1.1200-03 |
  | `szz_decision` | Решение об установлении СЗЗ | req_22 | СанПиН 2.2.1/2.1.1.1200-03 |

### 1.4 Статьи КоАП и штрафы
- Поля: `code`, `description`, `fine_min`, `fine_max`, `category`.
- Используется блоком «Риски» для расчёта критичности.
- Черновой список (ориентировочные значения для юрлиц):
  | Статья | Описание | Штраф (мин) | Штраф (макс) | Категория |
  |--------|----------|-------------|--------------|-----------|
  | 8.1 | Нарушение экологических требований при эксплуатации предприятий | 100000 | 250000 | общая |
  | 8.2 | Нарушение правил обращения с отходами | 100000 | 250000 | отходы |
  | 8.4 | Нарушение правил выбросов загрязняющих веществ | 200000 | 500000 | воздух |
  | 8.5 | Сокрытие или искажение экологической информации | 200000 | 500000 | общая |
  | 8.21 | Нарушение требований охраны атмосферного воздуха | 180000 | 300000 | воздух |
  | 8.22 | Нарушение требований охраны водных объектов | 200000 | 400000 | вода |
  | 8.31 | Нарушение требований санитарной защиты | 100000 | 300000 | СЗЗ |
  | 8.41 | Нарушение требований недропользования | 200000 | 500000 | вода/скважины |

## 2. Ручные корректировки требований

### 2.1 Операции
- Добавление требования вручную (причина, источник, срок).
- Исключение требования (со ссылкой на документ/письмо клиента).
- Переназначение статуса, ответственного, дедлайна.

### 2.2 Процесс утверждения
- Менеджер создаёт заявку на изменение.
- Админ подтверждает/отклоняет (для критичных операций).
- Все действия логируются в `RequirementAdjustment`:
  - `id`, `requirement_id`, `action`, `initiator_id`, `approved_by`, `timestamp`, `details`.

### 2.3 Влияние на систему
- После ручного исключения требование помечается как `source_rule = manual_override`.
- При следующем автоматическом пересчёте правило не должно возвращать исключённое требование — фиксируем исключение в списке override.
- Конфликт-менеджмент:
  1. Обновление правил требований выполняется в «preview»-режиме: расчёт новых требований без фактического применения.
  2. Для каждого результата проверяется наличие активного `RequirementOverride`:
     - `action = EXCLUDE` — требование не создаётся, в карточке отображается предупреждение «Исключено вручную (дата, инициатор)».
     - `action = INCLUDE` — требование добавляется независимо от условия, поле `source_rule` = `manual_override`.
  3. Overrides с `expires_at` < текущей даты помечаются статусом «требует решения»; админ принимает решение продлить/снять исключение перед применением новой версии правил.
  4. После утверждения изменений `RequirementRule.version` инкрементируется, а список затронутых overrides записывается в `RequirementAdjustment` для аудита.

## 3. Управление шаблонами событий

- Справочник `EventTemplate`: `code`, `title`, `default_periodicity`, `reminder_offsets`, `linked_requirement`.
- Позволяет откатывать и обновлять шаблоны при изменении законодательных сроков.
- Шаблоны применяются при создании новых клиентов или пересчёте календаря.

## 4. Данные пользователей и клиента

- Справочник регионов и территориальных органов (Роспотребнадзор, Росприроднадзор).
- Каталог отраслевых особенностей (например, животноводство, химпроизводство).
- Используется для дополнительных фильтров и рекомендаций в требованиях.

## 5. Журналирование и контроль качества

- Каждая правка справочной записи фиксируется в `ReferenceLog`.
- Раз в квартал проводится ревизия справочников (напоминание в календаре админа).
- Для критичных правок (смена НПА) система запускает пересчёт требований и уведомляет менеджеров.

## 6. Тестирование и проверки

- Модульные тесты на корректность интерпретации правил (`condition`).
- Проверки идентификации ссылок НПА (валидность URL, актуальная дата).
- Тесты на ручные корректировки: добавление/исключение, конфликт с авторасчётом.
- Нагрузочные тесты на массовое обновление справочников (batch-операции).

## Чек-лист готовности

- [x] Описаны ключевые справочники и их структуру.
- [x] Заданы процессы ручных корректировок и журналирования.
- [x] Учтены шаблоны событий и дополнительные классификаторы.
- [x] Определены тесты и ревизии.
- [ ] Заполнены фактические данные НПА, типов документов, штрафов (ожидает информации).

## Связанные документы и регламент обновлений

- `docs/requirements/catalog.md`, `docs/requirements/rules.md` — используют НПА и правила при расчёте требований.
- `docs/features/document-storage.md` — типы документов и политика хранения.
- `docs/features/risk-management.md` — таблица штрафов и статьи КоАП.
- `docs/features/calendar.md` — шаблоны событий и напоминания.
- `docs/admin/roles-and-permissions.md` — права доступа к справочникам и ручным корректировкам.
- `docs/documentation-todo.md` / `docs/completed/` — статусы задач и журнал изменений.

Перед обновлением справочников:
1. Подтвердить источники данных (НПА, штрафы) и оформить ссылку или запись в completed.
2. Проверить влияние на правила требований, календарь, риски и обновить соответствующие документы.
3. Обновить TODO-таблицу и создать запись в `docs/completed/` с указанием затронутых артефактов.
