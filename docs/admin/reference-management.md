# Управление справочниками и ручными корректировками

Документ описывает, как админ-панель обеспечивает поддержку нормативных данных, правил построения требований и ручных правок.

## 1. Справочники

### 1.1 Нормативно-правовые акты (НПА)
- Поля: `code`, `title`, `link`, `effective_from`, `effective_to`, `category` (воздух/вода/отходы/прочее), `status` (draft/active/archive).
- Для каждого НПА храним список связанных требований и документов.
- TODO: заполнить перечень НПА и ссылки после получения данных.

### 1.2 Правила построения требований
- Таблица `RequirementRule`:
  - `code` (req_01 …), `description`, `condition` (JSON/DSL), `source_npa`, `status`.
- Поддержка версионирования: изменения правил сохраняются с датой и автором.
- Возможна активация новой версии с отложенным вступлением в силу.

### 1.3 Типы документов
- Поля: `type_code`, `name`, `related_requirements`, `storage_policy` (срок хранения, размер).
- Связь с НПА для обоснования обязательности.
- TODO: заполнить маппинг типов документов ↔ НПА.

### 1.4 Статьи КоАП и штрафы
- Поля: `code`, `description`, `fine_min`, `fine_max`, `category`.
- Используется блоком «Риски» для расчёта критичности.
- TODO: уточнить актуальные штрафы.

## 2. Ручные корректировки требований

### 2.1 Операции
- Добавление требования вручную (причина, источник, срок).
- Исключение требования (со ссылкой на документ/письмо клиента).
- Переназначение статуса, ответственного, дедлайна.

### 2.2 Процесс утверждения
- Менеджер создаёт заявку на изменение.
- Админ подтверждает/отклоняет (для критичных операций).
- Все действия логируются в `RequirementAdjustment`:
  - `id`, `requirement_id`, `action`, `initiator_id`, `approved_by`, `timestamp`, `details`.

### 2.3 Влияние на систему
- После ручного исключения требование помечается как `source_rule = manual_override`.
- При следующем автоматическом пересчёте правило не должно возвращать исключённое требование — фиксируем исключение в списке override.
- TODO: описать конфликт-менеджмент при изменении правил (авто vs ручные overrides).

## 3. Управление шаблонами событий

- Справочник `EventTemplate`: `code`, `title`, `default_periodicity`, `reminder_offsets`, `linked_requirement`.
- Позволяет откатывать и обновлять шаблоны при изменении законодательных сроков.
- Шаблоны применяются при создании новых клиентов или пересчёте календаря.

## 4. Данные пользователей и клиента

- Справочник регионов и территориальных органов (Роспотребнадзор, Росприроднадзор).
- Каталог отраслевых особенностей (например, животноводство, химпроизводство).
- Используется для дополнительных фильтров и рекомендаций в требованиях.

## 5. Журналирование и контроль качества

- Каждая правка справочной записи фиксируется в `ReferenceLog`.
- Раз в квартал проводится ревизия справочников (напоминание в календаре админа).
- Для критичных правок (смена НПА) система запускает пересчёт требований и уведомляет менеджеров.

## 6. Тестирование и проверки

- Модульные тесты на корректность интерпретации правил (`condition`).
- Проверки идентификации ссылок НПА (валидность URL, актуальная дата).
- Тесты на ручные корректировки: добавление/исключение, конфликт с авторасчётом.
- Нагрузочные тесты на массовое обновление справочников (batch-операции).

## Чек-лист готовности

- [x] Описаны ключевые справочники и их структуру.
- [x] Заданы процессы ручных корректировок и журналирования.
- [x] Учтены шаблоны событий и дополнительные классификаторы.
- [x] Определены тесты и ревизии.
- [ ] Заполнены фактические данные НПА, типов документов, штрафов (ожидает информации).
