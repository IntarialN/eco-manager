# Роли и доступы

Документ определяет модель доступа для MVP личного кабинета. Все политики должны поддерживать расширение (например, добавление внешних аудиторов).

## 1. Базовые роли

| Роль | Описание | Зоны ответственности |
|------|----------|----------------------|
| `admin` | Сотрудник ООО «ГлавПриродБюро» с полным доступом | Управление пользователями, ролями, справочниками, просмотр всех данных |
| `client_manager` | Менеджер, ведущий конкретных клиентов | Создание/редактирование анкет, требований, документов и событий по своим клиентам |
| `project_specialist` | Эколог/аналитик | Выполнение задач по требованиям, аудит документов, комментарии |
| `client_user` | Представитель клиента | Просмотр своих данных, загрузка документов, отметка выполнения, получение уведомлений |
| `finance_manager` | Сотрудник бухгалтерии/финансового отдела | Управление договорами, счетами, актами, подтверждение оплат |
| `auditor` | Внутренний или внешний аудитор | Доступ «только чтение» к требованиям, документам, рискам без возможности правок |
| `external_viewer` | Ограниченный внешний пользователь (например, проверяющий орган) | Просмотр выбранных сущностей (требования/документы) по согласованию, без скачивания файлов по умолчанию |

## 2. Матрица доступа (высокоуровневая)

| Объект | admin | client_manager | project_specialist | client_user | finance_manager | auditor | external_viewer |
|--------|:-----:|:--------------:|:------------------:|:-----------:|:--------------:|:-------:|:---------------:|
| Клиенты (`clients`) | C/R/U/D | R/U (свои) | R (свои) | R (self) | R (свои) | R | R (ограничено) |
| Объекты (`sites`) | C/R/U/D | C/R/U (свои) | R (свои) | R (свои) | R (свои) | R | R (ограничено) |
| Требования | C/R/U/D | C/R/U (свои) | R/U (назначенные) | R/U (ограничено) | R (для связанных договоров) | R | R (только чтение) |
| Календарь | C/R/U/D | C/R/U (свои) | R/U (назначенные) | R (свои) | R (финансовые события) | R | R |
| Документы | C/R/U/D | C/R/U (свои клиенты) | R/U (назначенные) | C/R (свои) | R/U (финансовые документы) | R (read-only, без скачивания конфиденциальных файлов) | R (если разрешено) |
| Риски | C/R/U/D | C/R/U (свои) | R/U (назначенные) | R (свои) | R (финансовые риски) | R | R |
| Договоры/счета | C/R/U/D | C/R/U (свои) | R (назначенные) | R (свои) | C/R/U (финансовые) | R | R |
| Пользователи | C/R/U/D | R (свои клиенты) | — | — | — | — | — |
| Справочники НПА | C/R/U/D | R | R | — | — | R | — |

`C` — create, `R` — read, `U` — update, `D` — delete. Все действия ограничиваются RLS (строки привязаны к `client_id`/`site_id`).

## 3. RLS-политики

- Каждая таблица содержит поле `client_id` и/или `site_id`.
- Роль `client_user` видит строки, где `client_id` = его клиент.
- `client_manager` видит строки, где `client_id` ∈ списка назначенных клиентов.
- `project_specialist` видит строки, где он назначен ответственным или назначенным специалистом.
- `admin` видит все строки.
- Для файлов хранилища используется объектное ACL (владелец + наследование ролей).

## 4. Расширяемость прав

- Поверх ролей вводится система разрешений (`permissions`), например `can_manage_contracts`, `can_download_confidential_docs`.
- Админ может создавать кастомные наборы (для бухгалтера, юриста). Роль `finance_manager` наследует `can_manage_contracts`, `can_view_financial_risks`.
- `auditor` и `external_viewer` применяют «read only» политику: доступ к данным без возможности изменений и выгрузки (по умолчанию). Дополнительные разрешения выдаются точечно.

## 5. Аудит и журналирование

- Все операции изменения (C/U/D) записываются в `AuditLog` с указанием пользователя, сущности, деталей.
- Клиент может запросить выгрузку операций, связанных с его данными (GDPR/152-ФЗ).
- Админ отслеживает попытки несанкционированного доступа и блокирует пользователя.

## 6. Процесс управления доступом

1. Создание пользователя инициирует админ.
2. Менеджер подает заявку на добавление пользователя клиента.
3. Система отправляет приглашение на e-mail, пользователь задаёт пароль.
4. Изменение роли требует подтверждения админа.
5. Деактивация пользователя не удаляет данные; происходит блокировка доступа.

## 7. Проверки и тестирование

- Тесты RLS: попытка доступа к чужим данным должна возвращать ошибку/пустой результат.
- Проверка цепочки утверждения при назначении ролей.
- Нагрузочные тесты на журнал аудита.
- Проверка восстановления доступа (reset password, реактивация).

## Чек-лист готовности

- [x] Определены роли и зоны ответственности.
- [x] Сформирована матрица доступа и RLS-политики.
- [x] Описаны процессы управления пользователями.
- [x] Указаны требования по аудиту и тестированию.
- [ ] Уточнён список дополнительных ролей (ожидает обратной связи).
