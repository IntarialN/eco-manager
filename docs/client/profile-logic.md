# Логика профилирования клиента

Документ описывает, как данные из анкеты преобразуются в сущности личного кабинета: требования, календарные события, доступы и статусы договоров.

## 1. Общий поток данных

1. Менеджер заполняет анкету (`onboarding-form.md`).
2. Система валидирует обязательные поля и заносит записи в БД (клиент, объекты, ответственные лица, договора).
3. На основе категорий и параметров формируется карта требований (см. `docs/requirements/rules.md`).
4. Для каждого требования генерируются задачи/события календаря.
5. Настраиваются права доступа по ролям и создаются карточки договоров/счетов.

## 2. Маппинг полей анкеты → объекты системы

| Раздел анкеты | Поле | Назначение | Целевая сущность |
|---------------|------|------------|------------------|
| Общая информация | Юрлицо, ИНН/ОГРН | Идентификация клиента | `clients` |
| Объекты и НВОС | Категория, адрес, основания | Определение регуляторных требований | `sites`, `requirements` |
| Производственная деятельность | Объёмы выбросов/отходов, побочные продукты | Условия триггеров требований | `requirements`, `risk_indicators` |
| Водопользование | Скважина, водозабор | Дополнительные требования и календарь | `water_permits`, `requirements`, `calendar_events` |
| Документы и требования | Статус НООЛР, ПЭК и др. | Предзаполнение карточек требований, загрузка артефактов | `requirements`, `artifacts` |
| Ответственные лица | ФИО, обучение | Роли пользователей, напоминания по обучению | `users`, `calendar_events` |
| Договоры и расчёты | Договоры, счета, статусы | Интеграция с учетом, статусы оплат | `contracts`, `invoices` |
| Доп. сведения | Проверки, планы | Расширенные риски и задачи | `risk_log`, `roadmap` |
| Артефакты | Список документов, права | Загрузка в хранилище, RLS | `artifacts`, `permissions` |

## 3. Логика построения карты требований

1. По каждому объекту подтягиваем категорию НВОС.
2. Применяем базовые правила (`requirements/rules.md`) — создаём обязательные требования.
3. Проверяем пороговые значения (выбросы, отходы), наличие опасных веществ.
4. Добавляем требования по водопользованию и побочным продуктам.
5. Формируем требование по обучению, если удостоверения отсутствуют/истекают.
6. Для каждого требования:
   - Устанавливаем статус («Новая», «В работе», «Выполнено»).
   - Привязываем ответственного и срок.
   - Генерируем формы статотчётности (если применимо).

## 4. Календарь событий

- Источники дат: сроки отчётности (2-ТП, ПЭК), лицензии, договоры, обучение, напоминания НМУ.
- Для требований с цикличностью (ежегодно, ежеквартально) создаём повторяющиеся события.
- При закрытии требования календарь автоматически переносит дату на следующий период.
- Дополнительные события: даты проверок, аудитов, внутренние дедлайны клиента.

## 5. Управление артефактами

- Каждый документ привязывается к требованию, объекту или договору.
- При загрузке указываем тип документа, версию, дату, ответственного.
- Для файлов, требующих аудита, создаём задачу специалисту (статус «ожидает проверки»).
- Права доступа наследуются от ролей: клиент видит свои документы, менеджер — по своим клиентам, админ — по всем.

## 6. Статусы договоров/счетов/актов

- Данные из анкеты создают карточки договоров с начальными статусами.
- Интеграция с учётной системой обновляет статусы (через API) и триггерит уведомления.
- При изменении статуса формируем запись в ленте событий клиента.

## 7. Риски и уведомления

- На основании требований и доп. сведений рассчитываем риск-профиль (статьи КоАП, штрафы).
- При приближении дедлайнов, истечении лицензий или удостоверений создаём уведомления.
- История рисков хранится в `risk_log` с привязкой к объекту и требованию.

## 8. Проверки и подтверждение данных

- Менеджер подтверждает заполнение анкеты (чек-лист), система фиксирует дату и пользователя.
- Админ может запрашивать дополнительные документы перед активацией кабинета.
- Все изменения анкеты логируются (кто, когда, что изменил).

## Чек-лист готовности

- [x] Прописаны шаги преобразования данных анкеты.
- [x] Есть таблица маппинга полей → сущностей.
- [x] Отражена логика требований, календаря, артефактов и договоров.
- [x] Указаны механизмы рисков и проверки данных.
