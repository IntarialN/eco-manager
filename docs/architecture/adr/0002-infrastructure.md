# ADR 0002 — Инфраструктура и CI/CD для MVP

Дата: 2025-11-05  
Статус: Принято (рабочее решение команды для тестового задания)

## Контекст

Для запуска MVP необходимо определить инструменты окружений разработки, тестирования и продакшена. Решение должно:

- Позволять быстро поднимать локальное окружение.
- Поддерживать контейнеризацию сервисов и инфраструктурных компонентов (PostgreSQL, Redis, RabbitMQ, MinIO).
- Обеспечивать воспроизводимые пайплайны CI/CD с автоматическими проверками.
- Быть совместимым с выбранным стеком (React, NestJS, Prisma).
- Выполнять требования по резервному копированию и мониторингу.

## Решение

| Задача | Выбор | Обоснование |
|--------|-------|-------------|
| Локальная разработка | `docker-compose` (PostgreSQL, Redis, RabbitMQ, MinIO), сервисы запускаются через `nx run <target>` | Быстрый старт, единое управление зависимостями; позволяет разработчикам поднимать полный стек |
| Управление монорепо | Nx | Поддерживает TypeScript фронтенд и бэкенд, кэширует сборки, позволяет запускать команды на подграфе зависимостей |
| CI | GitHub Actions | Интеграция с репозиторием, удобное хранение секретов, возможность параллельных шагов (lint, тесты, e2e) |
| CD (staging/prod) | Argo CD для Kubernetes | GitOps-подход, автоматический деплой манифестов, контроль версий |
| Оркестрация | Kubernetes (managed-кластер, например Yandex Managed Service for K8s) | Позволяет масштабировать сервисы, использовать StatefulSet для БД и CronJob для бэкапов |
| Секреты | HashiCorp Vault (prod) / `.env` в dev | Централизованное управление секретами, интеграция с K8s через CSI driver |
| Мониторинг | Prometheus + Grafana + Loki + Alertmanager | Единый стек наблюдаемости, легко разворачивается в K8s (Helm chart) |
| Логи | Loki + Grafana, экспорт в объектное хранилище | Централизованный просмотр логов, долгосрочное хранение в YOS |
| Бэкапы | `velero` для кластерных ресурсов + `pgBackRest` для PostgreSQL, бэкапы MinIO в YOS | Соответствует требованиям по ежедневным копиям и хранению ≥ 30 дней |
| Статические артефакты | Docker Registry (GitHub Container Registry) | Хранение образов, автоматическая очистка старых тегов |

## Процессы

1. **CI Pipeline**
   - `lint` (ESLint, Stylelint) для фронтенда и бэкенда.
   - `test` (unit/integration) через Jest и Vitest.
   - `build` — сборка Docker-образов сервисов/приложений.
   - `security` — scan зависимостей (npm audit, Trivy).
   - Артефакты: образы помещаются в GHCR с тегами `sha` и `env`.

2. **CD Pipeline**
   - Манифесты в `infra/k8s/`.
   - Argo CD отслеживает ветки (`develop` → staging, `main` → prod).
   - Rollout происходит через `Deployment`/`StatefulSet` с контролем здоровья.
   - Секреты подтягиваются из Vault (prod) или Kubernetes Secrets (staging).

3. **Резервное копирование**
   - PostgreSQL: `pgBackRest` выполняет ежедневные бэкапы в YOS bucket (`db-backups`).
   - MinIO: ежедневные копии в `yandex-storage/eco-documents-backup`.
   - Конфигурации Kubernetes: `velero` с расписанием ежедневных backup.

4. **Мониторинг и алертинг**
   - Grafana дашборды: latency API, RabbitMQ queue depth, суммарный размер объектов.
   - Alertmanager уведомляет через email/чат-бот (тот же канал, что для клиентов, но другой топик).
   - Логи доступны через Loki + Grafana Explore; Retention 30 дней.

## Альтернативы

- **Docker Swarm** — проще, но ограничен по масштабированию и интеграции с экосистемой monitoring/secret management.
- **GitLab CI** — мощнее, но требует отдельного хостинга; GitHub Actions достаточны на MVP.
- **Manual деплой** (kubectl apply) — быстрее в реализации, но труднее контролировать и масштабировать.

## Последствия

- Требуется базовая экспертиза по Kubernetes/Argo CD, но это инвестирование в масштабируемость.
- Использование Nx требует унификации скриптов (команды `nx run` вместо `npm run`).
- Vault повышает безопасность, но требует настройки аутентификации приложения (K8s ServiceAccount).

## Следующие шаги

- Создать шаблоны `docker-compose.yaml` и `nx.json`/`workspace.json`.
- Подготовить базовые Helm charts или Kustomize overlays в `infra/k8s/`.
- Настроить GitHub Actions workflow (`.github/workflows/ci.yml`) с описанными стадиями.
- Задокументировать процедуру локального запуска и деплоя (`docs/infra/runbook.md`, TODO).
