# План интеграций

Документ описывает внутренние и внешние интеграции системы, протоколы обмена, форматы данных и требования к безопасности.

## 1. Внутренние API

| Поставщик | Потребитель | Назначение | Протокол | Примечания |
|-----------|-------------|------------|----------|------------|
| `auth-service` | `api-gateway`, `admin-console` | Аутентификация, выдача JWT/refresh токенов | REST/JSON | Поддержка OAuth2/Password |
| `requirements-service` | `api-gateway`, `admin-console`, `calendar-service`, `risk-service` | CRUD требований, расчёт правил | REST/GraphQL | Версионирование API (v1) |
| `documents-service` | `api-gateway`, `requirements-service` | Загрузка/выдача документов | REST + signed URL | Multipart upload |
| `calendar-service` | `api-gateway`, `notification-service` | Управление событиями, reminders | REST/JSON | Webhook для уведомлений |
| `risk-service` | `api-gateway`, `admin-console` | Расчёт и управление рисками | REST/JSON | Поддержка batch апдейтов |
| `billing-service` | `api-gateway`, `calendar-service`, `risk-service` | Данные договоров/счётов, статусы | REST/JSON | Кэширование для снижения нагрузки |
| `notification-service` | `api-gateway`, `calendar-service`, `risk-service` | Отправка уведомлений | REST + queue | Использование очереди для асинхронности |

## 2. Обмен событиями

- Используем RabbitMQ как основной брокер сообщений:
  - `requirement.created/updated`
  - `document.uploaded/approved`
  - `calendar.event.overdue`
  - `billing.invoice.overdue`
  - `risk.status.changed`
- Формат сообщений — JSON (схемы храним в `libs/data-models/events`), идентификатор корреляции передаётся в заголовках.
- Каждый сервис подписывается на релевантные события через отдельные очереди, снижая связанность.

## 3. Внешние интеграции

### 3.1 Учётная система (Bubble)

- **Назначение**: синхронизация договоров, счетов, актов.
- **Протокол**: REST API (HTTPS).
- **Требования**:
  - Авторизация по API-ключу (хранится в Secret Manager).
  - Ограничение частоты запросов (rate limit 60 rps — уточнить).
  - Поддержка вебхуков, если доступно (получение уведомлений об оплате).
- **Формат**: см. приложение `docs/architecture/mock-bubble-api.md` (эндпоинты, DTO).
- **Mock-сервис**: описан в `docs/architecture/mock-bubble-api.md`, используется до появления спецификации.

### 3.2 Уведомления

- Email: SMTP или сервис (SendGrid/Mailgun). Требуется TLS, SPF/DKIM/DMARC. SLA доставки — ≤15 минут.
- Чат-бот: Telegram API, авторизация по токену бота. Используется как второй канал с SLA ≤30 минут.
- SMS/телефония (опционально) — аварийный канал, SLA ≤15 минут после эскалации.
- fallback: при недоступности основного канала повторная отправка через следующий канал, результаты фиксируются в логах notification-service.

### 3.3 Хранилище документов

- Dev/stage: MinIO в приватном контуре; prod: Yandex Object Storage.
- Доступ через подписанные ссылки, управление ключами через KMS.
- Шифрование на уровне bucket + SSE; проверка соответствия требованиям РФ выполняется при переходе на prod.

## 4. Интеграция со справочниками НПА

- На MVP — ручное ведение (загрузка CSV/Excel админом).
- Перспектива: интеграция с внешними базами (Консультант, Техэксперт) через API.
- Требуются соглашения о лицензировании данных.

## 5. Безопасность интеграций

- Все внешние вызовы только по HTTPS, проверка сертификатов.
- Хранение секретов в Secrets Manager, ротация ключей согласно политике.
- Лимитирование и мониторинг API (rate limiting, circuit breaker).
- Логирование всех вызовов (успешных и ошибочных) для аудита.

## 6. Мониторинг и наблюдаемость

- Стандартные метрики Prometheus (latency, error rate) для внутренних API.
- Трассировка запросов (OpenTelemetry) для сквозного наблюдения.
- Дэшборды в Grafana/Cloud Monitoring.
- Настройка алертинга (PagerDuty, Opsgenie) при отклонениях SLA.

## 7. Этапы реализации интеграций

1. **MVP**:
   - Реализовать внутр. API между core-сервисами (auth, requirements, documents, calendar).
   - Настроить асинхронные события для требований/календаря.
   - Подключить базовое уведомление (email).
2. **Расширение**:
   - Интеграция с Bubble (pull статусов).
   - Добавить risk-service и webhook на просроченные события.
   - Подключить чат-бот/обратный звонок.
3. **Зрелость**:
   - Внешние базы НПА, автоматическое обновление справочников.
   - Расширенный notification-service (мультканальность, SLA).
   - Интеграция с BI-системами (Power BI, Data Studio).

## 8. TODO

- Получить полную спецификацию API Bubble (эндпоинты, авторизация, частота обновлений).
- Согласовать приоритеты каналов уведомлений и размеры очередей.
- Описать процессы отладки интеграций (sandbox окружения, тестовые ключи).

## Чек-лист готовности

- [x] Описаны внутренние API и события.
- [x] Зафиксированы внешние интеграции и требования безопасности.
- [x] Сформирован пошаговый план внедрения интеграций.
- [ ] Подтвердить технические детали (Bubble API, брокер, провайдеры) после получения данных.
