# Архитектурный обзор (Yii2 MVP)

Прототип личного кабинета реализован как монолитное приложение на Yii2 basic template. Основные блоки вынесены в отдельные модели и представления, что облегчает дальнейшее масштабирование или выделение модулей.

## Основные компоненты

| Компонент | Назначение |
|-----------|------------|
| `ClientController` | Точка входа в личный кабинет, агрегирует данные клиента и рендерит вкладки. |
| `models/Client` | Содержит общие сведения об организации, связи с площадками, требованиями, документами. |
| `models/Requirement` | Карта нормативных требований (код, статус, дедлайн, связанная площадка). |
| `models/Document` | Артефакты и документы (тип, статус, путь до файла). |
| `models/CalendarEvent` | Календарь событий (отчётность, проверки, напоминания). |
| `models/Risk` | Риски с оценкой серьёзности и потенциальными штрафами. |
| `models/Contract`, `Invoice`, `Act` | Блок договоров/счётов/актов. |
| `migrations/*` | Инициализация схемы БД и примерные данные по одному клиенту. |
| `views/client/*` | Представления для каждого блока (таблицы, карточки, аккордеоны). |

## Потоки данных

1. **Миграция** — `php yii migrate` создаёт SQLite базу и заполняет демо-данные (анкета клиента, требования, документы, календарь, риски, договоры).
2. **Веб-запрос** — при переходе на `/client/view` контроллер делает `Client::find()->with(...)` и передаёт данные во view.
3. **Интерфейс** — Bootstrap 5 вкладки/карточки отображают актуальную информацию по пяти основным блокам MVP.
4. **Артефакты** — файлы можно размещать в `web/uploads/`, путь хранится в таблице `document` (в демо указаны примеры).

## База данных

- SQLite (`yii-app/data/eco_manager.db` по умолчанию). Легко переключить на PostgreSQL/MySQL, изменив `config/db.php`.
- Основные таблицы: `client`, `site`, `requirement`, `document`, `calendar_event`, `risk`, `contract`, `invoice`, `act`.
- См. `docs/architecture/data-model.md` для логической ERD; миграция придерживается того же состава сущностей.

## Безопасность и роли

На уровне прототипа аутентификация не реализована. Для продакшена требуется подключить RBAC из `docs/admin/roles-and-permissions.md` и защиту доступа к файлам (`web/uploads`).

## TODO / дальнейшая работа

- Подключить авторизацию (Yii2 RBAC) и роли (`admin`, `client_manager`, `finance_manager`, `auditor`).
- Реализовать формы обновления статусов, загрузки документов, редактирования календаря.
- Вынести конфигурацию в `.env` + Docker/CI по ADR 0002 (как только определится целевая инфраструктура).
- Подготовить деплой на сервер (Nginx + PHP-FPM, sqlite/postgres backup).
- Синхронизировать диаграммы и модель данных при изменении схемы в миграциях.

## Связанные документы и регламент обновлений

- `docs/architecture/code-structure.md` — фактическая структура репозитория.
- `docs/architecture/data-model.md` и `docs/architecture/diagrams/*.puml` — сущности и визуальные представления.
- `docs/architecture/adr/*.md` — ключевые решения, влияющие на обзор.
- `docs/infra/runbook.md` — детали запуска, деплоя и инфраструктуры.
- `docs/features/*.md` — функциональные блоки, описанные в обзоре.
- `docs/documentation-todo.md` / `docs/completed/` — статусы и журнал изменений.

Перед обновлением обзора:
1. Свериться с актуальными ADR и миграциями, чтобы описания соответствовали реализованной структуре.
2. Обновить диаграммы и data-model, если появляются новые сущности или связи.
3. Зафиксировать изменения в `docs/completed/` и синхронизировать TODO/README при добавлении новых пунктов.
