# Архитектурный обзор

Документ описывает целевую архитектуру MVP личного кабинета клиента по экологии, включая основные сервисы, взаимодействия, внешние интеграции и потоки данных.

## 1. Архитектурные принципы

- **Модульность**: каждый сервис отвечает за один домен (требования, документы, календарь и т.д.).
- **Расширяемость**: возможность добавлять новые сервисы без перестройки монолита.
- **Безопасность**: централизованная аутентификация, RLS, шифрование, аудит.
- **Интегрируемость**: API-first подход, чётко определённые контракты между сервисами.
- **Надёжность**: независимое масштабирование сервисов, изоляция отказов.

## 2. Состав сервисов и технологии

| Сервис | Назначение | Технологии | Основные зависимости |
|--------|------------|------------|----------------------|
| `web-client` | Личный кабинет клиента | React + TypeScript + Vite + Tailwind | api-gateway |
| `admin-console` | Управление справочниками, ручные корректировки, мониторинг | React + TypeScript | auth, requirements, documents |
| `api-gateway` | Единая точка входа (REST/GraphQL), аутентификация/авторизация, маршрутизация | NestJS, GraphQL/REST | Auth, requirements, documents, calendar, risk, billing |
| `auth-service` | Управление пользователями, ролями, токенами, SSO | NestJS, Prisma, PostgreSQL | RBAC конфигурация |
| `requirements-service` | Расчёт и хранение требований, статусы, история | NestJS, Prisma, PostgreSQL | Documents, calendar, RabbitMQ |
| `documents-service` | Хранение и аудит артефактов, версия файлов | NestJS, Prisma, MinIO/Yandex Object Storage | Requirements, audit |
| `calendar-service` | Планирование событий, напоминания, повторяемость | NestJS, Redis (кэш), RabbitMQ | Requirements, documents, notifications |
| `risk-service` | Расчёт рисков, план действий, штрафы | NestJS, Prisma | Requirements, calendar, legislation DB |
| `billing-service` | Управление договорами, счетами, синхронизация с Бабл | NestJS, HTTP client | External API (Bubble), calendar, notifications |
| `notification-service` | Отправка уведомлений (email, чат-бот) | NestJS, RabbitMQ, SMTP/боты | calendar, risk, billing |

## 3. Логическая схема взаимодействий

```
               +----------------+
               |  web-client    |
               +--------+-------+
                        |
               +--------v-------+
               |  api-gateway   |
               +--+------+------+ 
                  |      |       
      +-----------+      +-------------------+
      |                                  |
+-----v-----+         +------------------v-----------------+
| auth      |         | requirements-service               |
+-----+-----+         +-----+--------+-------+-------------+
      |                     |        |       |
      |          +----------+        |       +------------------+
      |          |                   |                          |
+-----v-----+ +--v-----------+ +-----v------+        +----------v--------+
| admin     | | calendar     | | documents  |        | billing-service   |
| console   | +------+-------+ +-----+------+        +----------+--------+
| (UI)      |        |               |                        |
            |        |               |                        |
            |  +-----v------+  +-----v------+        +---------v---------+
            |  | notification|  | storage    |        | external Bubble  |
            |  +-------------+  +------------+        +------------------+
            |
+-----------v---------+
| risk-service        |
+-----------+---------+
            |
     +------v------+
     | legislation |
     | references  |
     +-------------+
```

*Примечание*: схема логическая; физическая реализация может объединять некоторые сервисы на MVP стадии (например, объединить risk и requirements).

## 4. Потоки данных

- **Регистрация/логин**: web-client → api-gateway → auth-service → возвращает токен → gateway устанавливает сессию.
- **Анкета клиента**: web-client → api-gateway → requirements-service (создание клиента/объектов) → запись в БД → вызов rules engine.
- **Генерация требований**: requirements-service использует справочники (rules, НПА) → создаёт записи → уведомляет calendar-service и risk-service.
- **Загрузка документов**: web-client → api-gateway → documents-service → загрузка в object storage → уведомление requirements-service (обновление статуса).
- **События календаря**: calendar-service получает данные от requirements/billing → создаёт события → обращается к notification-service для напоминаний.
- **Риски**: risk-service получает просрочки требований/событий → рассчитывает рисковые баллы → возвращает в web-client/admin-console.
- **Финансы**: billing-service получает данные от внешнего API (Bubble) → обновляет статусы договоров/счетов → инициирует события календаря и риски финансовой просрочки.

## 5. Хранилища данных

- **Основная БД**: PostgreSQL 15 с включёнными RLS-политиками.
- **Объектное хранилище**: MinIO (dev/stage) + Yandex Object Storage (prod), доступ через signed URL и KMS.
- **Очередь сообщений**: RabbitMQ (обменники per-домену).
- **Кэш**: Redis (сессии, rate limiting, подготовленные отчёты).
- **Логи и метрики**: Prometheus + Grafana + Loki, экспорт в централизованный журнал.

## 6. Внешние интеграции

- Учётная система (Bubble): синхронизация договоров/счетов через REST API (см. `integration-plan.md`).
- Отправка уведомлений: SMTP сервис, чат-бот (Telegram), SMS-шлюз (по SLA).
- Источники законодательства/НПА: пока ручное ведение справочника, автоматизация в бэклоге.

## 7. Масштабирование и отказоустойчивость

- Сервисы развёртываются в контейнерах, управляются оркестратором (Kubernetes).
- Горизонтальное масштабирование по нагрузке (статeless-сервисы через HPA).
- Использование circuit breaker/retry между сервисами (например, через service mesh).
- Репликация БД, регулярные бэкапы (см. безопасность).

## 8. TODO и открытые вопросы

- Уточнить, какие сервисы объединяем в рамках MVP (например, notifications внутри calendar).
- Подготовить диаграммы последовательности для ключевых сценариев (регистрация клиента, загрузка документа).
- Зафиксировать SLA по доступности и латентности для прод-окружения.

## Чек-лист готовности

- [x] Описаны принципы и состав сервисов.
- [x] Представлена логическая схема и основные потоки данных.
- [x] Зафиксированы хранилища и внешние интеграции.
- [x] Указаны направления масштабирования и TODO.
